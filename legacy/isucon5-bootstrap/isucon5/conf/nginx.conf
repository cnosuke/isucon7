worker_processes  4;

events {
  worker_connections  1024;
  multi_accept on;
  use epoll;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile         on;
  tcp_nopush       on;
  keepalive_timeout 120;

  upstream app {
    # server 127.0.0.1:8080;
    server unix:/tmp/unicorn.sock;
  }

  server {
    #log_format  main  '$remote_addr<>$remote_user<>$time_local<>$request<>'
    #                  '$status<>$body_bytes_sent<>$http_referer<>'
    #                  '$http_user_agent<>$http_x_forwarded_for<>'
    #                  '$upstream_response_time<>$request_time';
    # access_log  /var/log/nginx/access.log  main;
    access_log  off;

    gzip  on;
    gzip_vary on;
    gzip_min_length 500;
    gzip_http_version 1.0;
    gzip_comp_level   2;
    server_tokens off;

    root /home/isucon/webapp/static;
    try_files $uri @unicorn;

    location ~ ^/[^.+]$ {
        gzip_static on;
        expires max;
        add_header Cache-Control public;
    }

    location ~ ^/(css|fonts|js)/ {
        gzip_static on;
        # log_not_found off;
        expires     max;
        add_header  Cache-Control public;
    }

    location @unicorn {
      proxy_set_header Host $host;
      proxy_pass http://app;
    }
  }
}
